<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>C00lGUI — Full Simulator</title>
<style>
/* =========================================================================
   STYLE: Visual theme, terminal layout, progress bar, responsive tweaks
   ========================================================================== */
:root{
  --bg:#0b0b0b;
  --card:#0f0d0d;
  --red:#ff3b3b;
  --red-deep:#b71c1c;
  --accent:#ff6b6b;
  --muted:rgba(255,255,255,0.9);
  --mono: "Courier New", Courier, monospace;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:
  radial-gradient(ellipse at center,#0f0f12 0%, #020202 60%),
  linear-gradient(180deg,#060003 0%, #000 100%);
  color:var(--muted);font-family:Inter, system-ui, -apple-system,"Segoe UI",Roboto,Arial;}
/* Page card */
.wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;}
.card{
  width:1100px; max-width:96%;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;padding:28px;border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 30px 90px rgba(0,0,0,0.6); text-align:center;
}
.title{font-size:34px;color:var(--red-deep);font-weight:900;margin:0 0 8px 0;text-shadow:0 0 18px rgba(255,80,80,0.12);}
.sub{color:rgba(255,255,255,0.78);margin-bottom:14px;}
.enable{display:inline-block;padding:12px 18px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;}
.progressOuter{width:86%;height:14px;border-radius:8px;background:rgba(255,255,255,0.02);margin:14px auto;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
.progressInner{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--red));transition:width 80ms linear}

/* Terminal overlay */
#fakeCMD{
  display:none; position:fixed; top:6vh; left:6vw;
  width:88vw; height:88vh; max-width:1280px; max-height:920px;
  background:#070404; border:3px solid var(--red-deep); border-radius:10px;
  box-shadow:0 40px 160px rgba(183,28,28,0.35); z-index:99999; overflow:hidden;
  color:var(--red); font-family:var(--mono);
}
#cmdHeader{display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(90deg, rgba(255,0,0,0.02), rgba(255,0,0,0.01));border-bottom:1px solid rgba(255,0,0,0.04)}
#cmdTitle{font-weight:900;color:var(--red-deep);font-size:16px}
#cmdClose{margin-left:auto;background:transparent;border:none;color:var(--red);cursor:pointer;padding:8px 12px;border-radius:6px}
#cmdClose:hover{background:rgba(255,0,0,0.03)}
#cmdBody{padding:16px;height:calc(100% - 128px);overflow:auto;white-space:pre-wrap;font-size:14px;line-height:1.45;background:linear-gradient(180deg,#040303 0%, #000 100%)}
#cmdInputWrap{padding:10px 16px 18px 16px;border-top:1px solid rgba(255,0,0,0.03);display:flex;gap:8px;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
#cmdPrompt{font-family:var(--mono);font-size:14px;color:var(--red)}
#cmdInput{flex:1;background:transparent;border:none;outline:none;color:var(--red);font-family:var(--mono);font-size:14px}

/* Visual area inside terminal (SVG will be injected) */
.visual-wrap{margin:12px 0; display:flex; justify-content:center; align-items:center}
.visual-wrap svg{width:88%;max-width:920px;height:auto;display:block;background:#020202;border-radius:6px;border:1px solid rgba(255,255,255,0.02)}

/* small helpers */
.cmd-line{margin:6px 0;font-family:var(--mono);color:var(--red)}
.cmd-echo{font-weight:600;color:var(--red)}
.cmd-strong{font-weight:800;color:var(--red)}
.accessDenied{display:block;margin-top:8px;font-weight:900;font-size:34px;color:#ff4d4d;text-shadow:0 0 18px rgba(255,0,0,0.18);letter-spacing:2px}
.kbd{background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px;font-size:12px;color:var(--muted)}

@media (max-width:720px){ .card{padding:18px} #fakeCMD{top:3vh;left:2vw;width:96vw;height:94vh} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="main" aria-live="polite">
    <div class="title">WELCOME BACK C00lKID</div>
    <div class="sub">Client-only interactive simulator</div>
    <div id="enableTerminal" class="enable" tabindex="0">Enable terminal.. (or press Ctrl + R)</div>
    <div class="progressOuter" aria-hidden="false" style="margin-top:18px">
      <div id="progressFill" class="progressInner" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
    </div>
    <div class="hint" style="margin-top:8px">Wait for the progress to reach 100% (5s) before opening the terminal.</div>
  </div>
</div>

<!-- Fake Terminal -->
<div id="fakeCMD" role="dialog" aria-modal="true" aria-label="C00lKID Terminal">
  <div id="cmdHeader">
    <div id="cmdTitle">C00lKID TERMINAL</div>
    <div style="font-size:12px;color:rgba(255,255,255,0.12)"> — debug & simulation mode</div>
    <button id="cmdClose" aria-label="Close terminal">CLOSE</button>
  </div>

  <div id="cmdBody" tabindex="0" aria-live="polite"></div>

  <div id="cmdInputWrap">
    <div id="cmdPrompt">&gt;</div>
    <input id="cmdInput" autocomplete="off" spellcheck="false" aria-label="Terminal input" />
  </div>
</div>

<script>
/* =========================================================================
   FULL SCRIPT — includes all requested commands and features.
   - Ctrl+R is captured and prevented
   - Progress 5s initialization
   - Commands: firewall, hack, listen, control, spawn clone, inject, teleport,
               animation.stop(), destroy, help
   - SVG visual, clones move toward static target T
   - spawn clone removes old clones before spawning
   - animation.stop() stops animateMotion and clones
   - destroy() removes visual and resets state
   ========================================================================= */

/* ---------------------------
   DOM refs
   --------------------------- */
const enableTerminalBtn = document.getElementById('enableTerminal');
const progressFill = document.getElementById('progressFill');
const fakeCMD = document.getElementById('fakeCMD');
const cmdBody = document.getElementById('cmdBody');
const cmdInput = document.getElementById('cmdInput');
const cmdClose = document.getElementById('cmdClose');

/* ---------------------------
   State
   --------------------------- */
let initialized = false;
let initInterval = null;
let initProgress = 0;

let firewallBroken = false;
let runningHack = false;
let hackInterval = null;
let hackSucceeded = false;
let targetPassword = '';

let listenDone = false;
let svgContainer = null; // reference to SVG element
let svgWrap = null;      // wrapper div

let controlActive = false;

let cloneObjects = []; // meta for clones
let clonesActive = false;
let cloneLayer = null;

let CLONE_COUNT = 6;
let CLONE_DURATION = 5000;
let CLONE_SPEED = 3.0;

let currentInjectMode = 'random'; // 'random' | 'pathfinding' | 'cursor'
let lastCursorPos = { x: 120, y: 40 };

let animationStopped = false;

/* ---------------------------
   Helpers
   --------------------------- */
function appendLine(text, cls) {
  const el = document.createElement('div');
  el.className = cls ? 'cmd-line ' + cls : 'cmd-line';
  // remove colons per request
  el.innerHTML = String(text).replace(/:/g,'');
  cmdBody.appendChild(el);
  cmdBody.scrollTop = cmdBody.scrollHeight;
}
function escapeHtml(s) { return String(s).replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* ---------------------------
   Initialization progress (5s)
   --------------------------- */
(function startInit() {
  const totalMs = 5000;
  const stepMs = 50;
  const steps = Math.ceil(totalMs / stepMs);
  const inc = 100 / steps;
  initProgress = 0;
  progressFill.style.width = '0%';
  progressFill.setAttribute('aria-valuenow','0');

  initInterval = setInterval(() => {
    initProgress = Math.min(100, initProgress + inc);
    progressFill.style.width = Math.floor(initProgress) + '%';
    progressFill.setAttribute('aria-valuenow', Math.floor(initProgress));
    if (initProgress >= 100) {
      clearInterval(initInterval);
      initInterval = null;
      initialized = true;
    }
  }, stepMs);
})();

/* ---------------------------
   Terminal show/hide and keyboard handling
   --------------------------- */
function showTerminal() {
  if (!initialized) {
    // quick feedback: small pulse
    enableTerminalBtn.animate([{ transform: 'scale(0.995)' }, { transform: 'scale(1)' }], { duration: 120 });
    return;
  }
  fakeCMD.style.display = 'block';
  cmdBody.innerHTML = '';
  appendLine('<span style="color:#ff7b7b">[C00lKID TERMINAL v0.1]</span>', 'cmd-echo');
  cmdInput.focus();
}

function hideTerminal() {
  fakeCMD.style.display = 'none';
  if (runningHack && hackInterval) {
    clearInterval(hackInterval);
    hackInterval = null;
    runningHack = false;
  }
}

/* Click + keyboard hooks */
enableTerminalBtn.addEventListener('click', showTerminal);
enableTerminalBtn.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showTerminal(); }});
cmdClose.addEventListener('click', hideTerminal);

/* Capture Ctrl+R and prevent reload; open terminal instead */
window.addEventListener('keydown', e => {
  if (e.ctrlKey && (e.key === 'r' || e.key === 'R')) {
    e.preventDefault(); // STOP browser reload
    showTerminal();
  }
  if (e.key === 'Escape') {
    if (fakeCMD.style.display === 'block') { e.preventDefault(); hideTerminal(); }
  }
});

/* ---------------------------
   Hack sequence
   --------------------------- */
const noiseSamples = [
  "Loading kernel module... OK",
  "Resolving vector signature 0x" + Math.floor(Math.random()*0xFFFF).toString(16),
  "Spawning rogue thread at 0x" + Math.floor(Math.random()*0xFFFF).toString(16),
  "Buffering entropy... 32%",
  "Hash collision detected, retrying...",
  "Allocating virtual page " + Math.floor(Math.random()*4096),
  "Patching system call table... done",
  "Overflowing stack frame... warning",
  "Decrypting payload chunk 3/8",
  "Handshake with unknown host established",
  "Randomizing pointers... OK",
  "Clearing temp logs",
  "Flushing CPU cache lines",
  "Injecting packet to /dev/null",
  "Kernel panic simulated (test mode)"
];

function cmd_firewall() {
  if (firewallBroken) { appendLine('Firewall already broken'); return; }
  appendLine('> Engaging firewall breaker', 'cmd-echo');
  appendLine('Loading bypass modules');
  appendLine('Patching ACLs');
  setTimeout(() => {
    firewallBroken = true;
    appendLine('Firewall breaker engaged');
  }, 650);
}

function cmd_hack() {
  if (runningHack) { appendLine('Hack already running'); return; }
  appendLine('> Executing hack sequence', 'cmd-echo');
  runningHack = true;
  let ticks = 0; const maxTicks = 25;
  hackInterval = setInterval(() => {
    const lines = 1 + Math.floor(Math.random()*2);
    for (let i=0;i<lines;i++) {
      const idx = Math.floor(Math.random()*noiseSamples.length);
      const text = noiseSamples[idx].replace(/\d+/g, ()=>Math.floor(Math.random()*9999));
      appendLine(text);
    }
    ticks++;
    if (ticks >= maxTicks) {
      clearInterval(hackInterval);
      hackInterval = null;
      runningHack = false;
      if (!firewallBroken) {
        appendLine('');
        appendLine('<span class="accessDenied">ACCESS DENIED</span>');
      } else {
        targetPassword = genPassword(12);
        appendLine('');
        appendLine('<span class="cmd-strong">target password ' + targetPassword + '</span>');
        hackSucceeded = true;
        appendLine('(run listen next to visualize network; control after listen)');
      }
    }
  }, 200);
}

/* small password generator */
const usedPw = new Set();
function genPassword(len) {
  len = len || 12;
  const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  for (let tries=0; tries<5000; tries++) {
    let s='';
    for (let i=0;i<len;i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
    if (!usedPw.has(s)) { usedPw.add(s); return s; }
  }
  // fallback
  let f='';
  for (let i=0;i<len;i++) f += chars.charAt(Math.floor(Math.random()*chars.length));
  usedPw.add(f); return f;
}

/* ---------------------------
   Listen -> create SVG visual
   --------------------------- */
function cmd_listen() {
  if (!hackSucceeded) { appendLine('Listen denied — run hack successfully first'); return; }
  if (listenDone) { appendLine('Listen already completed'); return; }
  appendLine('> Listening for endpoints', 'cmd-echo');
  const steps = ['Probing local network','Collecting ARP','Scanning ports','Resolving DNS entries','Fetching routing table','Estimating latency','Enumerating remote hosts'];
  let s = 0; const maxS = 12;
  const si = setInterval(()=> {
    appendLine(steps[Math.floor(Math.random()*steps.length)] + ' ' + Math.floor(Math.random()*120));
    s++;
    if (s >= maxS) {
      clearInterval(si);
      createNetworkVisual();
      listenDone = true;
      appendLine('');
      appendLine('(listen complete — control available)');
    }
  }, 220);
}

/* createNetworkVisual: builds SVG showing computer -> globe -> target T */
function createNetworkVisual() {
  // wrapper
  const wrap = document.createElement('div'); wrap.className = 'visual-wrap';
  const svgns = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgns,'svg');
  svg.setAttribute('viewBox','0 0 240 80');
  svg.setAttribute('preserveAspectRatio','xMidYMid meet');

  // path (hidden) and visible dashed path
  const defs = document.createElementNS(svgns,'defs');
  const path = document.createElementNS(svgns,'path');
  const pid = 'netpath_' + Date.now();
  path.setAttribute('id', pid);
  path.setAttribute('d', 'M36,24 C80,24 128,36 156,36 C184,36 212,24 212,24');
  path.setAttribute('fill','none'); path.setAttribute('stroke','none');
  defs.appendChild(path); svg.appendChild(defs);

  const visPath = document.createElementNS(svgns,'path');
  visPath.setAttribute('d', path.getAttribute('d'));
  visPath.setAttribute('stroke','#ff6b6b');
  visPath.setAttribute('stroke-width','1.4');
  visPath.setAttribute('stroke-dasharray','6 6');
  visPath.setAttribute('fill','none');
  visPath.setAttribute('opacity','0.22');
  svg.appendChild(visPath);

  // computer
  const comp = document.createElementNS(svgns,'g'); comp.setAttribute('transform','translate(12,8) scale(1)');
  const compRect = document.createElementNS(svgns,'rect'); compRect.setAttribute('x','0'); compRect.setAttribute('y','0'); compRect.setAttribute('width','48'); compRect.setAttribute('height','32'); compRect.setAttribute('rx','4'); compRect.setAttribute('fill','#111'); compRect.setAttribute('stroke','#ff6b6b');
  comp.appendChild(compRect); svg.appendChild(comp);

  // globe
  const globeG = document.createElementNS(svgns,'g'); globeG.setAttribute('transform','translate(112,2) scale(1)');
  const globeCircle = document.createElementNS(svgns,'circle'); globeCircle.setAttribute('cx','28'); globeCircle.setAttribute('cy','28'); globeCircle.setAttribute('r','24'); globeCircle.setAttribute('fill','#071'); globeCircle.setAttribute('stroke','#ff6b6b');
  globeG.appendChild(globeCircle); svg.appendChild(globeG);

  // target T
  const tG = document.createElementNS(svgns,'g'); tG.setAttribute('transform','translate(212,12) scale(1)');
  const targetRect = document.createElementNS(svgns,'rect'); targetRect.setAttribute('id','targetT'); targetRect.setAttribute('x','0'); targetRect.setAttribute('y','0'); targetRect.setAttribute('width','24'); targetRect.setAttribute('height','24'); targetRect.setAttribute('rx','4'); targetRect.setAttribute('fill','#111'); targetRect.setAttribute('stroke','#ff6b6b');
  const tText = document.createElementNS(svgns,'text'); tText.setAttribute('x','12'); tText.setAttribute('y','16'); tText.setAttribute('font-size','14'); tText.setAttribute('text-anchor','middle'); tText.setAttribute('fill','#ff6b6b'); tText.textContent='T';
  tG.appendChild(targetRect); tG.appendChild(tText); svg.appendChild(tG);

  // arrow polygon with animateMotion
  const arrow = document.createElementNS(svgns,'polygon');
  arrow.setAttribute('points','0,0 0,6 9,3'); arrow.setAttribute('fill','#ff6b6b');
  const aMotion = document.createElementNS(svgns,'animateMotion'); aMotion.setAttribute('dur','3.6s'); aMotion.setAttribute('repeatCount','indefinite'); aMotion.setAttribute('rotate','auto');
  const mpath = document.createElementNS(svgns,'mpath'); mpath.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href','#' + pid);
  aMotion.appendChild(mpath); arrow.appendChild(aMotion); svg.appendChild(arrow);

  wrap.appendChild(svg);
  cmdBody.appendChild(wrap);
  cmdBody.scrollTop = cmdBody.scrollHeight;

  svgContainer = svg;

  // mouse handlers for cursor mode
  svg.addEventListener('mousemove', ev => {
    const rect = svg.getBoundingClientRect();
    const vb = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal : { x:0, y:0, width:240, height:80 };
    const x = ((ev.clientX - rect.left)/rect.width) * vb.width + vb.x;
    const y = ((ev.clientY - rect.top)/rect.height) * vb.height + vb.y;
    lastCursorPos = { x, y };
  });
  svg.addEventListener('click', ev => {
    const rect = svg.getBoundingClientRect();
    const vb = svg.viewBox && svg.viewBox.baseVal ? svg.viewBox.baseVal : { x:0, y:0, width:240, height:80 };
    const x = ((ev.clientX - rect.left)/rect.width) * vb.width + vb.x;
    const y = ((ev.clientY - rect.top)/rect.height) * vb.height + vb.y;
    lastCursorPos = { x, y };
    appendLine('cursor target set x=' + Math.round(x) + ' y=' + Math.round(y));
  });
}

/* ---------------------------
   Control
   --------------------------- */
function cmd_control() {
  if (!listenDone && !svgContainer) { appendLine('Control denied — run listen first'); return; }
  controlActive = true;
  appendLine('[CONTROL MODE ENGAGED]');
  appendLine('(spawn clone, inject, teleport now available)');
}

/* ---------------------------
   animation.stop(): stop animateMotion & clone movement
   --------------------------- */
function cmd_animation_stop() {
  if (!svgContainer) { appendLine('No visual to stop'); return; }
  // remove all animateMotion elements inside svg
  const anims = svgContainer.querySelectorAll('animateMotion');
  anims.forEach(a => { try { a.parentNode.removeChild(a); } catch(e){} });
  // stop clone updates
  clonesActive = false;
  animationStopped = true;
  appendLine('All animations stopped');
}

/* ---------------------------
   destroy(): remove svg & reset
   --------------------------- */
function cmd_destroy() {
  if (svgContainer) {
    const wrap = svgContainer.parentNode;
    if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap);
  }
  svgContainer = null;
  listenDone = false;
  controlActive = false;
  cloneObjects.forEach(o => { try { if (o.el && o.el.parentNode) o.el.parentNode.removeChild(o.el); } catch(e){} });
  cloneObjects = [];
  clonesActive = false;
  appendLine('Visual destroyed and state reset');
}

/* ---------------------------
   spawn clone (robust)
   - removes old clone layer if present
   - spawns clones that move toward static targetT
   --------------------------- */
function cmd_spawn_clone() {
  if (!controlActive) { appendLine('Spawn clone denied — control not active'); return; }
  if (!svgContainer) { appendLine('No visual present — run listen first'); return; }
  // remove existing clones if any
  if (cloneLayer && cloneLayer.parentNode) {
    try { cloneLayer.parentNode.removeChild(cloneLayer); } catch(e){}
    cloneLayer = null;
  }
  cloneObjects = []; clonesActive = false;
  // resolve static target coords
  let tx = null, ty = null;
  try {
    const tEl = svgContainer.querySelector('#targetT');
    if (tEl) { const bb = tEl.getBBox(); tx = bb.x + bb.width/2; ty = bb.y + bb.height/2; }
  } catch(e){}
  if (tx === null || ty === null) {
    const vb = svgContainer.viewBox && svgContainer.viewBox.baseVal ? svgContainer.viewBox.baseVal : { x:0, y:0, width:240, height:80 };
    tx = tx === null ? (vb.x + vb.width * 0.85) : tx;
    ty = ty === null ? (vb.y + vb.height * 0.5) : ty;
  }
  appendLine('> Spawning clones to static target T x=' + Math.round(tx) + ' y=' + Math.round(ty), 'cmd-echo');

  // create layer
  const svgns = 'http://www.w3.org/2000/svg';
  const g = document.createElementNS(svgns,'g');
  cloneLayer = g;
  svgContainer.appendChild(g);

  const vb = svgContainer.viewBox && svgContainer.viewBox.baseVal ? svgContainer.viewBox.baseVal : { x:0, y:0, width:240, height:80 };
  const startBaseX = vb.x + vb.width * 0.12;
  const startBaseY = vb.y + vb.height * 0.3;

  // spawn
  for (let i=0;i<CLONE_COUNT;i++){
    const c = document.createElementNS(svgns,'circle');
    const r = 4; c.setAttribute('r', r); c.setAttribute('fill', '#ff6b6b');
    const sx = startBaseX + (Math.random()-0.5)*20;
    const sy = startBaseY + (Math.random()-0.5)*12;
    c.__x = sx; c.__y = sy; c.setAttribute('cx', sx); c.setAttribute('cy', sy);
    g.appendChild(c);
    cloneObjects.push({ el: c, x: sx, y: sy, targetX: tx, targetY: ty, id: 'clone_' + Date.now() + '_' + i });
  }

  // animate clones using requestAnimationFrame
  clonesActive = true;
  animationStopped = false;
  const startTime = Date.now();
  let last = null;
  function step(now) {
    if (!clonesActive || animationStopped) { clonesActive = false; return; }
    if (!last) last = now;
    const dt = Math.min(64, now - last);
    last = now;
    const elapsed = Date.now() - startTime;
    for (let k=0;k<cloneObjects.length;k++){
      const o = cloneObjects[k];
      const cx = o.x, cy = o.y, tx2 = o.targetX, ty2 = o.targetY;
      const dx = tx2 - cx, dy = ty2 - cy;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist <= 0.9) { o.x = tx2; o.y = ty2; o.el.setAttribute('cx', o.x); o.el.setAttribute('cy', o.y); continue; }
      const baselinePerMs = CLONE_SPEED / 16.0;
      const stepPx = baselinePerMs * dt;
      if (stepPx >= dist) { o.x = tx2; o.y = ty2; } else { o.x += (dx / dist) * stepPx; o.y += (dy / dist) * stepPx; }
      o.el.setAttribute('cx', o.x); o.el.setAttribute('cy', o.y);
    }
    if (elapsed < CLONE_DURATION) requestAnimationFrame(step);
    else { clonesActive = false; appendLine('clone sequence complete - ' + Math.round(CLONE_DURATION/1000) + 's elapsed'); }
  }
  requestAnimationFrame(step);
  appendLine('Spawned ' + cloneObjects.length + ' clones');
}

/* ---------------------------
   inject <mode> - set mode
   --------------------------- */
function cmd_inject(mode) {
  if (!controlActive) { appendLine('Inject denied — control not active'); return; }
  const m = (mode || '').trim().toLowerCase();
  if (!m) { appendLine('Specify inject mode: random, pathfinding, cursor'); return; }
  if (['random','pathfinding','cursor'].indexOf(m) === -1) { appendLine('Unknown inject mode ' + escapeHtml(m)); return; }
  currentInjectMode = m;
  appendLine('inject mode set to ' + currentInjectMode);
}

/* ---------------------------
   teleport (visual) and nudge
   --------------------------- */
function cmd_teleport() {
  if (!controlActive) { appendLine('Teleport denied — control not active'); return; }
  if (!svgContainer) { appendLine('No visual — run listen'); return; }
  appendLine('> Initiating teleport transfer', 'cmd-echo');
  const svgns = 'http://www.w3.org/2000/svg';
  const p = document.createElementNS(svgns,'circle'); p.setAttribute('r',3.6); p.setAttribute('fill','#ff6b6b'); p.setAttribute('opacity','0.98');
  // starting from target
  let sx = 212, sy = 24;
  try { const te = svgContainer.querySelector('#targetT'); if (te) { const b = te.getBBox(); sx = b.x + b.width/2; sy = b.y + b.height/2; } } catch(e){}
  p.setAttribute('cx', sx); p.setAttribute('cy', sy); svgContainer.appendChild(p);
  const pathPts = [{x:sx,y:sy},{x:160,y:30},{x:110,y:26},{x:36,y:24}];
  const dur = 2200; const st = Date.now();
  (function anim(){
    const now = Date.now(); const t = Math.min(1, (now - st) / dur);
    const segCount = pathPts.length - 1;
    const segT = t * segCount;
    const segIdx = Math.min(segCount-1, Math.floor(segT));
    const localT = segT - segIdx;
    const p0 = pathPts[segIdx], p1 = pathPts[segIdx+1];
    const nx = p0.x + (p1.x - p0.x) * localT;
    const ny = p0.y + (p1.y - p0.y) * localT;
    p.setAttribute('cx', nx); p.setAttribute('cy', ny);
    if (t < 1) requestAnimationFrame(anim); else { try{ p.parentNode.removeChild(p); }catch(e){} appendLine('teleport transfer complete'); }
  })();
  for (let i=0;i<cloneObjects.length;i++){ try{ const c = cloneObjects[i]; c.x += (Math.random()-0.5)*18; c.y += (Math.random()-0.5)*12; c.el.setAttribute('cx',c.x); c.el.setAttribute('cy',c.y); }catch(e){} }
}

/* ---------------------------
   Input routing
   --------------------------- */
cmdInput.addEventListener('keydown', function(e){
  if (e.key !== 'Enter') return;
  const raw = cmdInput.value.trim(); cmdInput.value = '';
  if (!raw) return;
  appendLine('> ' + escapeHtml(raw), 'cmd-echo');
  const parts = raw.split(/\s+/);
  const cmd = parts[0].toLowerCase();
  const rest = parts.slice(1).join(' ');

  if (cmd === 'firewall') { cmd_firewall(); return; }
  if (cmd === 'hack') { cmd_hack(); return; }
  if (cmd === 'listen') { cmd_listen(); return; }
  if (cmd === 'control') { cmd_control(); return; }
  if ((cmd === 'spawn' && parts[1] && parts[1].toLowerCase() === 'clone') || cmd === 'clone') { cmd_spawn_clone(); return; }
  if (cmd === 'inject') { cmd_inject(rest); return; }
  if (cmd === 'teleport') { cmd_teleport(); return; }
  if (cmd === 'animation.stop' || (cmd === 'animation' && parts[1] && parts[1].toLowerCase() === 'stop')) { cmd_animation_stop(); return; }
  if (cmd === 'destroy') { cmd_destroy(); return; }
  if (cmd === 'help') {
    appendLine('Available commands', 'cmd-strong');
    appendLine('- firewall');
    appendLine('- hack');
    appendLine('- listen');
    appendLine('- control');
    appendLine('- spawn clone');
    appendLine('- inject <random|pathfinding|cursor>');
    appendLine('- teleport');
    appendLine('- animation.stop');
    appendLine('- destroy');
    appendLine('- help');
    return;
  }
  appendLine('Unknown command ' + escapeHtml(raw));
});

/* ---------------------------
   Useful diagnostics (exposed in window for console)
   --------------------------- */
window.C00L = {
  appendLine,
  cmd_spawn_clone: cmd_spawn_clone,
  cmd_spawn_clone_impl: cmd_spawn_clone, // alias
  cmd_destroy,
  cmd_animation_stop
};

/* =========================================================================
   End main script
   ========================================================================= */
</script>

</body>
</html>
